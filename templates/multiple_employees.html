{% extends "base.html" %}

{% block title %}Multiple Employees Turnover Rate Prediction{% endblock %}

{% block content %}
<h1 class="title">Multiple Employees Turnover Rate Prediction</h1>
<hr class="header-line">
<div class="multiple-employees-container">

    <div id="loading-spinner" style="display: none;">
        <div class="spinner"></div>
        <p>Loading... Please wait.</p>
    </div>

    {% if error %}
    <div class="error-message">
        <p>{{ error }}</p>
    </div>
    {% endif %}

    <p class="description">
        Enter employee data to analyze potential turnover rate.<br>
        Upload a file that includes multiple employees' details.<br>
        Make sure that all attribute columns are present and filled in correctly.
    </p>

    <form action="/predict_from_csv" method="POST" enctype="multipart/form-data" class="upload-form" id="upload-form"
        onsubmit="handleFormSubmit()">
        <div class="file-upload" id="file-upload">
            <label for="csv_file">Select file(s) to upload or drag and drop</label>
            <input type="file" id="csv_file" name="csv_file" accept=".csv" multiple required>
            <small>Supported file types: CSV (Max 5 files)</small>
        </div>

        <div id="selected-files" class="selected-files">
            {% if filenames %}
            {% for filename in filenames %}
            <p>File selected: <strong>{{ filename }}</strong> <span class="remove-file"
                    onclick="removeFile('{{ filename }}')">X</span></p>
            {% endfor %}
            {% endif %}
        </div>

        <button type="submit" class="predict-button">Predict Turnover Rate</button>
    </form>

    {% if turnover_rates is defined %}
    <div class="prediction-result">
        <h2>Prediction Results</h2>
        {% for filename, data in turnover_rates.items() %}
        <div class="prediction-result">
            <p>Turnover rate for <strong>{{ filename }}</strong>: </p>
            <p
                class="prediction-percentage {% if data.turnover_rate <= 33 %}low-risk{% elif data.turnover_rate <= 66 %}medium-risk{% else %}high-risk{% endif %}">
                <strong>{{ "%.2f"|format(data.turnover_rate) }}%</strong>
            </p>
            <div class="action-buttons">
                <button id="toggle-button-{{ filename }}" onclick="showTableWithSpinner('{{ filename }}')"
                    class="show-table-button">Show Table</button>
                <a href="/download_csv?filename={{ filename }}" class="download-button">Download CSV</a>
            </div>
            <div id="table-{{ filename }}" class="review-table" style="display: none;">
                <h3>Review Table for {{ filename }}</h3>
                <div class="filter-checkboxes">
                    <label>
                        <input type="checkbox" id="low-risk-checkbox-{{ filename }}" checked
                            onclick="filterTable('{{ filename }}')"> Low Risk
                    </label>
                    <label>
                        <input type="checkbox" id="medium-risk-checkbox-{{ filename }}" checked
                            onclick="filterTable('{{ filename }}')"> Medium Risk
                    </label>
                    <label>
                        <input type="checkbox" id="high-risk-checkbox-{{ filename }}" checked
                            onclick="filterTable('{{ filename }}')"> High Risk
                    </label>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Satisfaction Level</th>
                                <th>Last Evaluation</th>
                                <th>Number of Projects</th>
                                <th>Average Monthly Hours</th>
                                <th>Years Spent in Company</th>
                                <th>Work Accident</th>
                                <th>Promoted in Last 5 Years</th>
                                <th>Department</th>
                                <th>Salary</th>
                                <th>Probability</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in predictions[filename] %}
                            <tr
                                class="{% if row.probability * 100 <= 33 %}low-risk-table{% elif row.probability * 100 <= 66 %}medium-risk-table{% else %}high-risk-table{% endif %}">
                                <td>{{ "%.2f"|format(row.satisfaction_level) }}</td>
                                <td>{{ "%.2f"|format(row.last_evaluation) }}</td>
                                <td>{{ row.number_project }}</td>
                                <td>{{ row.average_montly_hours }}</td>
                                <td>{{ row.time_spend_company }}</td>
                                <td>{{ row.Work_accident }}</td>
                                <td>{{ row.promotion_last_5years }}</td>
                                <td>{{ row.department }}</td>
                                <td>{{ row.salary }}</td>
                                <td>{{ "%.2f"|format(row.probability * 100) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% if data.suggestions %}
            <div class="recommendations">
                <h2>Recommendations</h2>
                <p>To improve retention, consider focusing on the following metrics:</p>
                <ul>
                    {% for suggestion in data.suggestions %}
                    <li>{{ suggestion }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
    function showLoadingSpinner() {
        document.getElementById('loading-spinner').style.display = 'flex';
    }

    function hideLoadingSpinner() {
        document.getElementById('loading-spinner').style.display = 'none';
    }

    function handleFormSubmit() {
        // Show the loading spinner
        showLoadingSpinner();

        // Optionally, disable the submit button to prevent multiple submissions
        const submitButton = document.querySelector('.predict-button');
        submitButton.disabled = true;

        // Submit the form
        document.getElementById('upload-form').submit();
    }

    function showTableWithSpinner(filename) {
        showLoadingSpinner(); // Show the spinner
        setTimeout(() => {
            toggleTable(filename);
            hideLoadingSpinner();
        }, 500);
    }

    function toggleTable(filename) {
        const table = document.getElementById(`table-${filename}`);
        const button = document.getElementById(`toggle-button-${filename}`);

        if (table.style.display === 'none') {
            table.style.display = 'block';
            button.textContent = 'Hide Table';
        } else {
            table.style.display = 'none';
            button.textContent = 'Show Table';
        }
    }

    const fileUpload = document.getElementById('file-upload');
    const fileInput = document.getElementById('csv_file');

    fileUpload.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUpload.classList.add('dragover');
    });

    fileUpload.addEventListener('dragleave', () => {
        fileUpload.classList.remove('dragover');
    });

    fileUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUpload.classList.remove('dragover');

        const newFiles = e.dataTransfer.files;
        const existingFiles = fileInput.files;
        const updatedFiles = new DataTransfer();

        for (let i = 0; i < existingFiles.length; i++) {
            updatedFiles.items.add(existingFiles[i]);
        }

        for (let i = 0; i < newFiles.length; i++) {
            updatedFiles.items.add(newFiles[i]);
        }

        fileInput.files = updatedFiles.files;
        updateSelectedFiles();
    });

    fileInput.addEventListener('change', () => {
        updateSelectedFiles();
    });

    function updateSelectedFiles() {
        const selectedFiles = document.getElementById('selected-files');
        selectedFiles.innerHTML = '';

        if (fileInput.files.length > 0) {
            for (let i = 0; i < fileInput.files.length; i++) {
                selectedFiles.innerHTML += `<p>File selected: <strong>${fileInput.files[i].name}</strong> <span class="remove-file" onclick="removeFile('${fileInput.files[i].name}')">X</span></p>`;
            }
        }
    }

    function removeFile(filename) {
        const dataTransfer = new DataTransfer();
        for (let i = 0; i < fileInput.files.length; i++) {
            if (fileInput.files[i].name !== filename) {
                dataTransfer.items.add(fileInput.files[i]);
            }
        }
        fileInput.files = dataTransfer.files;
        updateSelectedFiles();
    }

    function filterTable(filename) {
        const lowRiskChecked = document.getElementById(`low-risk-checkbox-${filename}`).checked;
        const mediumRiskChecked = document.getElementById(`medium-risk-checkbox-${filename}`).checked;
        const highRiskChecked = document.getElementById(`high-risk-checkbox-${filename}`).checked;

        const table = document.getElementById(`table-${filename}`).getElementsByTagName('tbody')[0];
        const rows = table.getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const isLowRisk = row.classList.contains('low-risk-table');
            const isMediumRisk = row.classList.contains('medium-risk-table');
            const isHighRisk = row.classList.contains('high-risk-table');

            if (
                (lowRiskChecked && isLowRisk) ||
                (mediumRiskChecked && isMediumRisk) ||
                (highRiskChecked && isHighRisk)
            ) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    }

    function formatSuggestions() {
        const suggestionItems = document.querySelectorAll('.recommendations li');

        suggestionItems.forEach((li) => {
            const text = li.textContent;
            const firstSentenceEnd = text.indexOf('.'); // Find the first dot

            if (firstSentenceEnd !== -1) {
                const firstSentence = text.slice(0, firstSentenceEnd);
                const restOfText = text.slice(firstSentenceEnd).trim();
                li.innerHTML = `<span class="first-sentence">${firstSentence}</span>${restOfText}`;
            }
        });
    }

    window.onload = formatSuggestions;
</script>
{% endblock %}